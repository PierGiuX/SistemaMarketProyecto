<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Lista de Productos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Restaurar valores al cargar la página
            const params = new URLSearchParams(window.location.search);
            if(params.get('criterio')) {
                document.getElementById("criterio").value = params.get('criterio');
                actualizarCampoBusqueda();
                
                if(params.get('criterio') === 'categoria') {
                    document.getElementById("valorCategoria").value = params.get('valor');
                } else {
                    document.getElementById("valorTexto").value = params.get('valor');
                }
            }
        });

        function actualizarCampoBusqueda() {
            const criterio = document.getElementById("criterio").value;
            const inputTexto = document.getElementById("valorTexto");
            const selectCategoria = document.getElementById("valorCategoria");

            if (criterio === "categoria") {
                inputTexto.disabled = true;
                selectCategoria.disabled = false;
                inputTexto.value = ""; // Limpiar campo de texto
            } else {
                inputTexto.disabled = false;
                selectCategoria.disabled = true;
                selectCategoria.value = ""; // Limpiar selección de categoría
            }
        }

        function confirmarEliminacion(element) {
            const descripcion = element.getAttribute("data-descripcion");
            return confirm(`¿Seguro de eliminar: ${descripcion}?`);
        }
    </script>
</head>
<body class="bg-light">

<div class="container mt-5">
    <h2 class="mb-4 text-center">Gestión de Productos</h2>

    <!-- Botón nuevo producto -->
    <div class="mb-3">
        <a th:href="@{/productos/nuevo}" class="btn btn-success">
            <i class="fas fa-plus"></i> Nuevo Producto
        </a>
    </div>

    <!-- Formulario de búsqueda -->
    <form th:action="@{/productos/buscar}" method="get" class="row g-3 mb-4">
        <div class="col-md-3">
            <select name="criterio" id="criterio" class="form-select" onchange="actualizarCampoBusqueda()" required>
                <option value="">Buscar por...</option>
                <option value="categoria">Categoría</option>
                <option value="codigo">Código</option>
                <option value="descripcion">Descripción</option>
            </select>
        </div>

        <!-- Campo de texto (para código o descripción) -->
        <div class="col-md-4">
            <input type="text" name="valor" id="valorTexto" class="form-control" placeholder="Ingrese valor..." />

            <!-- Campo de categoría -->
            <select name="valor" id="valorCategoria" class="form-select mt-2" disabled>
                <option value="">Seleccione una categoría</option>
                <option th:each="cat : ${categorias}"
                        th:value="${cat.id_categoria}"
                        th:text="${cat.nombre}">
                </option>
            </select>
        </div>

        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">
                <i class="fas fa-search"></i> Buscar
            </button>
        </div>
    </form>

    <!-- Tabla de productos -->
    <div class="table-responsive">
        <table class="table table-bordered table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Código</th>
                    <th>Descripción</th>
                    <th>Categoría</th>
                    <th>Precio</th>
                    <th>Stock</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="producto : ${productos}">
                    <td th:text="${producto.id_producto}"></td>
                    <td th:text="${producto.codigoInventario}"></td>
                    <td th:text="${producto.descripcion}"></td>
                    <td th:text="${producto.categoria != null ? producto.categoria.nombre : 'Sin categoría'}"></td>
                    <td th:text="${#numbers.formatDecimal(producto.precio, 1, 2)}"></td>
                    <td th:text="${producto.stock}"
                        th:classappend="${producto.stock < 10} ? 'text-danger fw-bold' : ''"></td>
                    <td>
                        <a th:href="@{'/productos/editar/' + ${producto.id_producto}}" class="btn btn-sm btn-warning">
                            <i class="fas fa-edit"></i> Editar
                        </a>
                        <a th:href="@{'/productos/eliminar/' + ${producto.id_producto}}"
                           th:attr="data-descripcion=${producto.descripcion}"
                           onclick="return confirmarEliminacion(this)"
                           class="btn btn-sm btn-danger">
                            <i class="fas fa-trash-alt"></i> Eliminar
                        </a>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div th:if="${#lists.isEmpty(productos)}" class="alert alert-info mt-4">
        No se encontraron productos.
    </div>
</div>

<!-- FontAwesome -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>