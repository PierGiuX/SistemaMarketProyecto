<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Formulario de Producto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script>
        function obtenerPrefijoCategoria(nombre) {
            const map = {
                'BEBIDAS': 'BEB',
                'CONDIMENTOS': 'CON',
                'FRUTAS/VERDURAS': 'FRU',
                'CARNES': 'CAR',
                'PESCADO/MARISCO': 'PES',
                'LACTEOS': 'LAC',
                'REPOSTERIA': 'REP',
                'GRANOS/CEREALES': 'GRA'
            };
            return map[nombre] || 'XXX';
        }

        function actualizarCodigoInventario() {
            const categoriaSelect = document.getElementById("categoria");
            const seccion = document.getElementById("seccion").value.toUpperCase();
            const estante = document.getElementById("estante").value.toUpperCase();
            const nivel = document.getElementById("nivel").value.toUpperCase();

            const nombreCategoria = categoriaSelect.options[categoriaSelect.selectedIndex].text;
            const prefijoCategoria = obtenerPrefijoCategoria(nombreCategoria);
            const ubicacion = `${seccion}${estante}${nivel}`;

            if (seccion.length !== 1 || estante.length !== 1 || nivel.length !== 1) {
                document.getElementById("codigoInventarioVisible").value = "";
                document.getElementById("codigoInventario").value = "";
                return;
            }

            const codigoTemporal = `${prefijoCategoria}-${ubicacion}-0000`;
            document.getElementById("codigoInventarioVisible").value = codigoTemporal;
            document.getElementById("codigoInventario").value = codigoTemporal;
            document.getElementById("seccionHidden").value = seccion;
            document.getElementById("estanteHidden").value = estante;
            document.getElementById("nivelHidden").value = nivel;
        }
    </script>
</head>
<body class="bg-light">

<div class="container mt-5">
    <h2 th:text="${producto.id_producto == 0} ? 'Registrar Producto' : 'Editar Producto'" class="mb-4"></h2>

    <form th:action="@{/productos/guardar}" th:object="${producto}" method="post" class="row g-3">
        <!-- ID oculto -->
        <input type="hidden" th:field="*{id_producto}" />

        <!-- Código de Inventario oculto -->
        <input type="hidden" th:field="*{codigoInventario}" id="codigoInventario" />

        <!-- Ocultos para ubicación -->
        <input type="hidden" name="seccion" id="seccionHidden" />
        <input type="hidden" name="estante" id="estanteHidden" />
        <input type="hidden" name="nivel" id="nivelHidden" />

        <!-- Categoría -->
        <div class="col-md-6">
            <label for="categoria" class="form-label">Categoría</label>
            <select id="categoria" th:field="*{categoria.id_categoria}" name="categoria.id_categoria"
                    class="form-select"
                    onchange="actualizarCodigoInventario()"
                    th:disabled="${producto.id_producto != null and producto.id_producto != 0}">
                <option value="">Seleccione una categoría</option>
                <option value="1" th:selected="${producto.categoria?.id_categoria == 1}">BEBIDAS</option>
                <option value="2" th:selected="${producto.categoria?.id_categoria == 2}">CONDIMENTOS</option>
                <option value="3" th:selected="${producto.categoria?.id_categoria == 3}">FRUTAS/VERDURAS</option>
                <option value="4" th:selected="${producto.categoria?.id_categoria == 4}">CARNES</option>
                <option value="5" th:selected="${producto.categoria?.id_categoria == 5}">PESCADO/MARISCO</option>
                <option value="6" th:selected="${producto.categoria?.id_categoria == 6}">LACTEOS</option>
                <option value="7" th:selected="${producto.categoria?.id_categoria == 7}">REPOSTERIA</option>
                <option value="8" th:selected="${producto.categoria?.id_categoria == 8}">GRANOS/CEREALES</option>
            </select>

            <!-- Campo oculto para enviar categoría si está deshabilitada -->
            <input type="hidden"
                   th:if="${producto.id_producto != null and producto.id_producto != 0}"
                   name="categoria.id_categoria"
                   th:value="${producto.categoria?.id_categoria}" />
        </div>

        <!-- Código visible -->
        <div class="col-md-6">
            <label class="form-label">Código de Inventario</label>
            <input type="text" id="codigoInventarioVisible" class="form-control" readonly
                   th:value="${producto.codigoInventario}" />
        </div>

        <!-- Descripción -->
        <div class="col-md-12">
            <label class="form-label">Descripción</label>
            <input type="text" th:field="*{descripcion}" class="form-control" required />
        </div>

        <!-- Ubicación -->
        <div class="col-md-4">
            <label class="form-label">Sección</label>
            <input type="text" id="seccion" maxlength="1" class="form-control"
                   th:readonly="${producto.id_producto != null and producto.id_producto != 0}"
                   oninput="actualizarCodigoInventario()" />
        </div>

        <div class="col-md-4">
            <label class="form-label">Estante</label>
            <input type="text" id="estante" maxlength="1" class="form-control"
                   th:readonly="${producto.id_producto != null and producto.id_producto != 0}"
                   oninput="actualizarCodigoInventario()" />
        </div>

        <div class="col-md-4">
            <label class="form-label">Nivel</label>
            <input type="text" id="nivel" maxlength="1" class="form-control"
                   th:readonly="${producto.id_producto != null and producto.id_producto != 0}"
                   oninput="actualizarCodigoInventario()" />
        </div>

        <!-- Precio -->
        <div class="col-md-6">
            <label class="form-label">Precio</label>
            <input type="number" step="0.01" th:field="*{precio}" class="form-control" required />
        </div>

        <!-- Stock -->
        <div class="col-md-6">
            <label class="form-label">Stock</label>
            <input type="number" th:field="*{stock}" class="form-control" required />
        </div>

        <!-- Botones -->
        <div class="col-12 text-end">
            <button type="submit" class="btn btn-primary">Guardar Producto</button>
            <a th:href="@{/productos}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>